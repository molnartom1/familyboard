<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Csal√°di Napt√°r √©s Bev√°s√°rl√≥lista</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" sizes="192x192" href="icon-192.png" />
  <meta name="theme-color" content="#247BFF" />
  <link rel="stylesheet" href="style.css" />

  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore-compat.js"></script>

  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function (OneSignal) {
      await OneSignal.init({
        appId: "2b31e6a9-343b-453b-b208-b4111f1dcc84",
        notifyButton: { enable: true },
      });
    });
  </script>

  <style>
    /* S√∂t√©t √©s vil√°gos m√≥d st√≠lusok */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: white;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark {
      background-color: #121212;
      color: #e0e0e0;
    }
    .calendar-view-selector button {
      margin: 5px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: none;
      color: inherit;
    }
    .calendar-view-selector button.active {
      border-color: #247BFF;
      font-weight: bold;
    }
    /* Egyszer≈± napt√°r st√≠lus */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
      user-select: none;
    }
    .calendar-cell {
      border: 1px solid #ccc;
      padding: 6px;
      min-height: 60px;
      position: relative;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .calendar-cell.today {
      background-color: #e0f7fa;
    }
    body.dark .calendar-cell.today {
      background-color: #004d40;
    }
    .calendar-cell.selected {
      border-color: #247BFF;
      background-color: #bbdefb;
    }
    body.dark .calendar-cell.selected {
      background-color: #1565c0;
    }
    .calendar-header {
      display: flex;
      justify-content: center;
      margin-bottom: 5px;
    }
    .calendar-header button {
      margin: 0 10px;
      font-size: 20px;
      background: none;
      border: none;
      cursor: pointer;
      color: inherit;
    }
    /* Dark mode toggle */
    #dark-mode-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 6px 12px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: none;
      color: inherit;
      font-size: 14px;
      z-index: 9999;
    }
    #dark-mode-toggle.dark {
      border-color: #e0e0e0;
    }
  </style>
</head>
<body>
<button id="dark-mode-toggle">S√∂t√©t m√≥d</button>

<div id="login-section">
  <h2>PIN k√≥dos bel√©p√©s</h2>
  <form id="pin-form" style="display:flex; flex-direction:column; gap:1rem;">
    <input
      type="tel"
      id="pin-input"
      inputmode="numeric"
      pattern="[0-9]*"
      maxlength="8"
      placeholder="PIN (2025)"
    />
    <button id="pin-submit" type="button">Bel√©p√©s</button>
  </form>
  <div class="error" id="pin-error"></div>
</div>

<div id="main-section" style="display:none;">
  <header>
    <h1>üóìÔ∏è Csal√°di Napt√°r | üõí Bev√°s√°rl√≥lista</h1>
    <button id="logout-btn">Kijelentkez√©s</button>
  </header>

  <section class="calendar-card">
    <div id="nevnap-box" style="font-weight:bold; font-size:1.2em; margin-bottom:1em;"></div>

    <div class="calendar-view-selector" style="text-align:center; margin-bottom:10px;">
      <button data-view="day" class="active">Napi n√©zet</button>
      <button data-view="week">Heti n√©zet</button>
      <button data-view="year">√âves n√©zet</button>
    </div>

    <div id="calendar-title" style="text-align:center; font-weight:bold; margin-bottom:5px;"></div>
    <div id="calendar-grid" class="calendar-grid"></div>
  </section>

  <section id="calendar">
    <h2>Esem√©ny hozz√°ad√°s</h2>
    <form id="event-form">
      <input type="text" id="event-title" placeholder="Esem√©ny neve" required />
      <input type="time" id="event-from-time" required />
      <input type="time" id="event-to-time" required />
      <button type="submit">Hozz√°ad√°s</button>
    </form>
    <ul id="event-list"></ul>
  </section>

  <section id="shopping">
    <h2>Bev√°s√°rl√≥lista</h2>
    <form id="item-form">
      <input type="text" id="item-title" placeholder="T√©tel neve" required />
      <button type="submit">Hozz√°ad√°s</button>
    </form>
    <ul id="item-list"></ul>
  </section>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAeoxtOe5Cleasm3KdeSHP9WDR3PkU-N1I",
    authDomain: "mosas-nyilvantartas.firebaseapp.com",
    projectId: "mosas-nyilvantartas",
    storageBucket: "mosas-nyilvantartas.firebasestorage.app",
    messagingSenderId: "38259241645",
    appId: "1:38259241645:web:26070b1d0686def9f00c24",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  db.enablePersistence().catch(function (err) {
    console.log("Offline t√°mogat√°s hib√°ja:", err.code);
  });

  const CORRECT_PIN = "2025";
  const loginSection = document.getElementById("login-section");
  const mainSection = document.getElementById("main-section");
  const pinInput = document.getElementById("pin-input");
  const pinBtn = document.getElementById("pin-submit");
  const pinError = document.getElementById("pin-error");

  pinBtn.onclick = function () {
    if (pinInput.value === CORRECT_PIN) {
      loginSection.style.display = "none";
      mainSection.style.display = "block";
      anonymousSignIn();
    } else {
      pinError.innerText = "Hib√°s PIN!";
    }
  };
  pinInput.addEventListener("keyup", function (event) {
    if (event.key === "Enter") pinBtn.click();
  });
  document.getElementById("logout-btn").onclick = function () {
    mainSection.style.display = "none";
    loginSection.style.display = "block";
    pinInput.value = "";
    firebase.auth().signOut();
  };

  function askPinForDelete(cb) {
    let pin = prompt("T√∂rl√©shez add meg a PIN-t:");
    if (pin === CORRECT_PIN) cb();
    else alert("Hib√°s PIN!");
  }

  function anonymousSignIn() {
    auth
      .signInAnonymously()
      .then(() => {
        fetchMonthlyEventsAndRender();
        loadEvents();
        loadItems();
      })
      .catch((error) => {
        pinError.innerText = "Firebase auth hiba: " + error.message;
      });
  }

  let calendarView = "day";
  function setCalendarView(view) {
    calendarView = view;
    renderCalendar();
    renderEvents();
  }

  const calendarGrid = document.getElementById("calendar-grid");
  const calendarTitle = document.getElementById("calendar-title");
  const prevMonthBtn = document.createElement("button");
  prevMonthBtn.textContent = "‚Üê";
  prevMonthBtn.classList.add("calendar-arrow");
  const nextMonthBtn = document.createElement("button");
  nextMonthBtn.textContent = "‚Üí";
  nextMonthBtn.classList.add("calendar-arrow");

  const calendarCard = document.querySelector(".calendar-card");
  const calendarHeader = calendarCard.querySelector(".calendar-header") || document.createElement("div");
  calendarHeader.classList.add("calendar-header");
  calendarHeader.innerHTML = "";
  calendarHeader.appendChild(prevMonthBtn);
  calendarHeader.appendChild(calendarTitle);
  calendarHeader.appendChild(nextMonthBtn);
  if (!calendarCard.querySelector(".calendar-header")) calendarCard.insertBefore(calendarHeader, calendarCard.firstChild);

  let currentDate = new Date();

  prevMonthBtn.onclick = () => {
    if (calendarView === "year") {
      currentDate = new Date(currentDate.getFullYear() - 1, 0, 1);
    } else if (calendarView === "week") {
      currentDate.setDate(currentDate.getDate() - 7);
    } else {
      // day or default month navigation
      currentDate.setMonth(currentDate.getMonth() - 1);
    }
    renderCalendar();
  };

  nextMonthBtn.onclick = () => {
    if (calendarView === "year") {
      currentDate = new Date(currentDate.getFullYear() + 1, 0, 1);
    } else if (calendarView === "week") {
      currentDate.setDate(currentDate.getDate() + 7);
    } else {
      currentDate.setMonth(currentDate.getMonth() + 1);
    }
    renderCalendar();
  };

  document.querySelectorAll(".calendar-view-selector button").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      document.querySelectorAll(".calendar-view-selector button").forEach((b) => b.classList.remove("active"));
      e.target.classList.add("active");
      setCalendarView(e.target.getAttribute("data-view"));
    });
  });

  function renderCalendar() {
    calendarGrid.innerHTML = "";
    if (calendarView === "day") {
      renderDayView();
    } else if (calendarView === "week") {
      renderWeekView();
    } else if (calendarView === "year") {
      renderYearView();
    }
  }

  function renderDayView() {
    calendarTitle.textContent = currentDate.toLocaleDateString("hu-HU", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });

    const dayStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
    calendarGrid.style.gridTemplateColumns = "repeat(1, 1fr)";

    let cell = document.createElement("div");
    cell.className = "calendar-cell selected";
    cell.textContent = dayStart.toLocaleDateString("hu-HU", { weekday: "long", day: "numeric", month: "short" });
    calendarGrid.appendChild(cell);
  }

  function renderWeekView() {
    const weekStart = new Date(currentDate);
    weekStart.setDate(currentDate.getDate() - ((currentDate.getDay() + 6) % 7));

    calendarTitle.textContent = `Heti n√©zet - ${weekStart.toLocaleDateString("hu-HU", {
      day: "numeric",
      month: "long",
      year: "numeric",
    })}`;

    calendarGrid.style.gridTemplateColumns = "repeat(7, 1fr)";

    for (let i = 0; i < 7; i++) {
      let d = new Date(weekStart);
      d.setDate(weekStart.getDate() + i);

      let cell = document.createElement("div");
      cell.className = "calendar-cell";
      cell.textContent = d.toLocaleDateString("hu-HU", { weekday: "short", day: "numeric" });

      calendarGrid.appendChild(cell);
    }
  }

  function renderYearView() {
    const year = currentDate.getFullYear();
    calendarTitle.textContent = year;

    calendarGrid.style.gridTemplateColumns = "repeat(3, 1fr)";
    calendarGrid.style.gridTemplateRows = "repeat(4, 1fr)";

    for (let month = 0; month < 12; month++) {
      const monthDiv = document.createElement("div");
      monthDiv.classList.add("calendar-month");
      monthDiv.style.border = "1px solid #ccc";
      monthDiv.style.margin = "5px";
      monthDiv.style.padding = "5px";
      monthDiv.style.backgroundColor = "rgba(180, 215, 255, 0.2)";
      monthDiv.style.borderRadius = "5px";

      const monthTitle = document.createElement("div");
      monthTitle.style.textAlign = "center";
      monthTitle.style.fontWeight = "bold";
      monthTitle.style.marginBottom = "5px";
      monthTitle.textContent = new Date(year, month, 1).toLocaleString("hu-HU", { month: "long" });
      monthDiv.appendChild(monthTitle);

      // Show days of the month in a small grid
      const firstDay = new Date(year, month, 1).getDay() || 7;
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const daysGrid = document.createElement("div");
      daysGrid.style.display = "grid";
      daysGrid.style.gridTemplateColumns = "repeat(7, 1fr)";
      daysGrid.style.gap = "2px";

      // Days names row
      ["H", "K", "Sz", "Cs", "P", "Szo", "V"].forEach((dayName) => {
        const dayNameDiv = document.createElement("div");
        dayNameDiv.style.fontWeight = "bold";
        dayNameDiv.style.textAlign = "center";
        dayNameDiv.textContent = dayName;
        daysGrid.appendChild(dayNameDiv);
      });

      // Blank days before first day of month
      for (let i = 1; i < firstDay; i++) {
        const blankDay = document.createElement("div");
        daysGrid.appendChild(blankDay);
      }

      // Days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = document.createElement("div");
        dayDiv.textContent = day;
        dayDiv.style.textAlign = "center";
        dayDiv.style.cursor = "pointer";
        dayDiv.style.padding = "3px 0";
        dayDiv.className = "calendar-day";
        // Add click event to select day
        dayDiv.addEventListener("click", () => {
          currentDate = new Date(year, month, day);
          setCalendarView("day");
          renderCalendar();
          loadEvents();
        });
        daysGrid.appendChild(dayDiv);
      }

      monthDiv.appendChild(daysGrid);
      calendarGrid.appendChild(monthDiv);
    }
  }

  function renderEvents() {
    const eventList = document.getElementById("event-list");
    eventList.innerHTML = "";
    const startDate = new Date(currentDate);
    let endDate;

    if (calendarView === "day") {
      endDate = new Date(currentDate);
    } else if (calendarView === "week") {
      endDate = new Date(currentDate);
      endDate.setDate(endDate.getDate() + 6);
    } else if (calendarView === "year") {
      endDate = new Date(currentDate.getFullYear(), 11, 31);
    }

    db.collection("events")
      .where("from", ">=", toFirestoreDate(startDate))
      .where("from", "<=", toFirestoreDate(endDate))
      .orderBy("from")
      .get()
      .then((snapshot) => {
        let eventsToShow = [];
        snapshot.forEach((doc) => {
          const eventDate = new Date(doc.data().from);
          if (
            calendarView === "day" &&
            eventDate.toDateString() === startDate.toDateString()
          ) {
            eventsToShow.push(doc.data());
          } else if (
            calendarView === "week" &&
            eventDate >= startDate &&
            eventDate <= endDate
          ) {
            eventsToShow.push(doc.data());
          } else if (calendarView === "year" && eventDate.getFullYear() === startDate.getFullYear()) {
            eventsToShow.push(doc.data());
          }
        });

        eventList.innerHTML = "";
        for (const event of eventsToShow) {
          const li = document.createElement("li");
          li.textContent = `${event.title} (${event.from.slice(0, 10)})`;
          eventList.appendChild(li);
        }
      });
  }

  function toFirestoreDate(date) {
    return date.toISOString().slice(0, 10) + "T00:00:00";
  }

  // Event felv√©tel
  const eventForm = document.getElementById("event-form");
  eventForm.onsubmit = (e) => {
    e.preventDefault();
    const title = document.getElementById("event-title").value;
    const fromTime = document.getElementById("event-from-time").value;
    const toTime = document.getElementById("event-to-time").value;
    if (!title || !fromTime || !toTime) return;

    const from = `${currentDate.toISOString().slice(0, 10)}T${fromTime}`;
    const to = `${currentDate.toISOString().slice(0, 10)}T${toTime}`;

    db.collection("events")
      .add({
        title,
        from,
        to,
        done: false,
      })
      .then(() => {
        eventForm.reset();
        renderCalendar();
        renderEvents();
      });
  };

  // Tov√°bbi megl√©v≈ë f√ºggv√©nyek: esem√©nyek, lista, PIN kezel√©s, stb. maradnak a hely√ºk√∂n...

  // Egy√©b funkci√≥k (Bev√°s√°rl√≥lista, PIN kezel√©sek, stb.)
  // ...

  // S√∂t√©t m√≥d v√°lt√°s
  const darkModeToggle = document.getElementById("dark-mode-toggle");
  darkModeToggle.onclick = () => {
    document.body.classList.toggle("dark");
    darkModeToggle.classList.toggle("dark");
    if (document.body.classList.contains("dark")) {
      darkModeToggle.textContent = "Vil√°gos m√≥d";
      localStorage.setItem("theme", "dark");
    } else {
      darkModeToggle.textContent = "S√∂t√©t m√≥d";
      localStorage.setItem("theme", "light");
    }
  };

  // Bet√∂lt√©skor t√©ma be√°ll√≠t√°sa helyi t√°rol√≥b√≥l
  window.addEventListener("load", () => {
    const savedTheme = localStorage.getItem("theme") || "light";
    if (savedTheme === "dark") {
      document.body.classList.add("dark");
      darkModeToggle.classList.add("dark");
      darkModeToggle.textContent = "Vil√°gos m√≥d";
    }
  });
</script>
</body>
</html>
