<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Csal√°di Napt√°r √©s Bev√°s√°rl√≥lista</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="icon-192.png">
  <meta name="theme-color" content="#247BFF">
  <link rel="stylesheet" href="style.css">

  <!-- Firebase compat (maradhat, de √©rdemes modul√°ris SDK-ra v√°ltani) -->
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore-compat.js"></script>

  <script src="nevnapok.js"></script>
</head>
<body>\n  <div style='padding:1rem;text-align:center'><a href='blog/blog.html'>‚û°Ô∏è Blog t√≠pus√∫ √ºzen≈ëfal</a></div>
<div id="login-section">
  <h2>PIN k√≥dos bel√©p√©s</h2>
  <form id="pin-form" style="display:flex; flex-direction:column; gap:1rem;">
    <input type="password" id="pin-input" inputmode="numeric" pattern="[0-9]*" maxlength="8" placeholder="PIN (2025)" autocomplete="one-time-code">
    <button id="pin-submit" type="button">Bel√©p√©s</button>
  </form>
  <div class="error" id="pin-error"></div>
</div>

<div id="main-section" style="display:none;">
  <header>
    <h1>FamilyBoard - Csal√°di Napt√°r</h1>
    <div style="display:flex;gap:10px;align-items:center;">
      <a href="weather.html" class="weather-link" style="
        background:#247BFF;
        color:white;
        padding:0.5em 1em;
        border-radius:8px;
        text-decoration:none;
        font-weight:bold;
      ">üå¶Ô∏è Id≈ëj√°r√°s</a>
      <button id="logout-btn">Kijelentkez√©s</button>
    </div>
  </header>

  <section class="calendar-card">
    <div id="nevnap-box" style="font-weight:bold;font-size:1.2em;margin-bottom:1em;"></div>

    <div class="calendar-header">
      <button id="prev-month" class="calendar-arrow">‚Üê</button>
      <span id="calendar-title"></span>
      <button id="next-month" class="calendar-arrow">‚Üí</button>
    </div>

    <div class="calendar-days">
      <span>H</span><span>K</span><span>Sz</span><span>Cs</span><span>P</span><span>Szo</span><span>V</span>
    </div>
    <div id="calendar-grid" class="calendar-grid"></div>
  </section>

  <section id="calendar">
    <h2>üóìÔ∏è Esem√©ny hozz√°ad√°s</h2>
    <form id="event-form">
      <input type="text" id="event-title" placeholder="Esem√©ny neve" required>
      <input type="time" id="event-from-time" required>
      <input type="time" id="event-to-time" required>
      <button type="submit">Hozz√°ad√°s</button>
    </form>
    <ul id="event-list"></ul>
  </section>

  <section id="shopping">
    <h2>üõí Bev√°s√°rl√≥lista</h2>
    <form id="item-form">
      <input type="text" id="item-title" placeholder="T√©tel neve" required>
      <button type="submit">Hozz√°ad√°s</button>
    </form>
    <ul id="item-list"></ul>
  </section>
</div>

<script>
/* --- Firebase init --- */
const firebaseConfig = {
  apiKey: "AIzaSyAeoxtOe5Cleasm3KdeSHP9WDR3PkU-N1I",
  authDomain: "mosas-nyilvantartas.firebaseapp.com",
  projectId: "mosas-nyilvantartas",
  // Ha kell Storage: storageBucket: "mosas-nyilvantartas.appspot.com",
  messagingSenderId: "38259241645",
  appId: "1:38259241645:web:26070b1d0686def9f00c24"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
db.enablePersistence().catch(err => {
  console.log("Offline t√°mogat√°s hib√°ja:", err.code);
});

/* --- √Ålland√≥k √©s elemek --- */
const CORRECT_PIN = "2025"; // csak UI ‚Äì ne tekintsd val√≥di v√©delemnek!
const loginSection = document.getElementById("login-section");
const mainSection = document.getElementById("main-section");
const pinInput = document.getElementById("pin-input");
const pinBtn = document.getElementById("pin-submit");
const pinError = document.getElementById("pin-error");

const calendarGrid = document.getElementById("calendar-grid");
const calendarTitle = document.getElementById("calendar-title");
const prevMonthBtn = document.getElementById("prev-month");
const nextMonthBtn = document.getElementById("next-month");

const eventForm = document.getElementById("event-form");
const eventList = document.getElementById("event-list");
const itemForm = document.getElementById("item-form");
const itemList = document.getElementById("item-list");

/* --- Hasznos seg√©dek --- */
// Helyi d√°tum YYYY-MM-DD form√°tumban (sv-SE = ISO-like, helyi id≈ëz√≥na)
function localYMD(date = new Date()) {
  return date.toLocaleDateString('sv-SE'); // "2025-11-04"
}
function todayYMD() { return localYMD(new Date()); }

/* --- √Ållapot --- */
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let selectedDay = todayYMD();
let eventsUnsub = null; // az onSnapshot leiratkoz√°s√°hoz
let itemsUnsub = null;

/* --- PIN login / logout --- */
pinBtn.onclick = function () {
  if (pinInput.value === CORRECT_PIN) {
    localStorage.setItem("fb_logged_in", "1");
    loginSection.style.display = "none";
    mainSection.style.display = "block";
    anonymousSignIn();
  } else {
    pinError.innerText = "Hib√°s PIN!";
  }
};
pinInput.addEventListener("keyup", function (event) {
  if (event.key === "Enter") pinBtn.click();
});

document.getElementById("logout-btn").onclick = async function () {
  localStorage.removeItem("fb_logged_in");
  mainSection.style.display = "none";
  loginSection.style.display = "block";
  pinInput.value = "";
  if (eventsUnsub) { eventsUnsub(); eventsUnsub = null; }
  if (itemsUnsub) { itemsUnsub(); itemsUnsub = null; }
  try { await auth.signOut(); } catch (e) { console.log(e); }
};

/* --- Firebase auth --- */
function anonymousSignIn() {
  // Ha m√°r be vagyunk jelentkezve, ne csin√°ljunk semmit
  if (auth.currentUser) {
    afterAuthReady();
    return;
  }
  auth.signInAnonymously()
    .then(afterAuthReady)
    .catch(error => {
      pinError.innerText = "Firebase auth hiba: " + error.message;
    });
}
function afterAuthReady() {
  fetchMonthlyEventsAndRender();
  subscribeEventsForSelectedDay();
  subscribeItems();
}
// Autologin oldalbet√∂lt√©skor, NEM anonymousSignIn-en bel√ºl!
window.addEventListener('DOMContentLoaded', () => {
  if (localStorage.getItem("fb_logged_in") === "1") {
    loginSection.style.display = "none";
    mainSection.style.display = "block";
    anonymousSignIn();
  }
});
auth.onAuthStateChanged(user => {
  if (user) {
    fetchMonthlyEventsAndRender();
  }
});

/* --- Napt√°r render --- */
function renderCalendar(evMap = {}) {
  const d = new Date(currentYear, currentMonth);
  calendarTitle.textContent = `${currentYear}, ${d.toLocaleString('hu', { month: 'long' })}`;

  const firstDay = new Date(currentYear, currentMonth, 1).getDay() || 7; // H√©tf≈ë=1 ... Vas√°rnap=7
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  calendarGrid.innerHTML = "";

  for (let i = 1; i < firstDay; i++) { calendarGrid.innerHTML += `<div></div>`; }

  const today = todayYMD();
  for (let day = 1; day <= daysInMonth; day++) {
    const cellDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

    let cls = "";
    if (cellDate === today) cls += " today";
    if (cellDate === selectedDay) cls += " selected";

    const eventi = evMap[cellDate] || [];
    let dotsHTML = "";
    let countHTML = "";

    if (eventi.length > 0) {
      const dotCount = Math.min(eventi.length, 3);
      for (let i = 0; i < dotCount; i++) {
        dotsHTML += `<div class="calendar-dot" style="left:${28 + 18 * i}%"></div>`;
      }
      if (eventi.length > 3) {
        countHTML = `<span class="calendar-count">(${eventi.length})</span>`;
      }
    }

    calendarGrid.innerHTML += `
      <div class="calendar-cell${cls}" data-date="${cellDate}" style="position:relative;">
        ${day}
        ${dotsHTML}
        ${countHTML}
      </div>
    `;
  }

  document.querySelectorAll('.calendar-cell').forEach(cell => {
    cell.onclick = () => {
      selectedDay = cell.getAttribute('data-date');
      document.querySelectorAll('.calendar-cell').forEach(c => c.classList.remove('selected'));
      cell.classList.add('selected');
      // √∫jrafeliratkoz√°s az adott nap esem√©nyeire
      subscribeEventsForSelectedDay();
    };
  });
}

prevMonthBtn.onclick = () => {
  currentMonth--;
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  fetchMonthlyEventsAndRender();
};
nextMonthBtn.onclick = () => {
  currentMonth++;
  if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  fetchMonthlyEventsAndRender();
};

function fetchMonthlyEventsAndRender() {
  const start = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-01T00:00`;
  const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
  const end = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}T23:59`;

  db.collection("events")
    .where("from", ">=", start)
    .where("from", "<=", end)
    .get()
    .then(snapshot => {
      const evMap = {};
      snapshot.forEach(doc => {
        const data = doc.data();
        const d = (data.from || "").slice(0, 10);
        if (!d) return;
        (evMap[d] ||= []).push(data);
      });
      renderCalendar(evMap);
    })
    .catch(err => console.log(err));
}

/* --- Esem√©nyek (nap szerinti) --- */
function subscribeEventsForSelectedDay() {
  if (eventsUnsub) { eventsUnsub(); eventsUnsub = null; }

  const fromStart = `${selectedDay}T00:00`;
  const toEnd = `${selectedDay}T23:59`;

  eventsUnsub = db.collection("events")
    .where("from", ">=", fromStart)
    .where("from", "<=", toEnd)
    .orderBy("from")
    .onSnapshot(snap => {
      eventList.innerHTML = "";
      snap.forEach(doc => {
        const { title, from, to, done } = doc.data();
        const li = document.createElement("li");
        if (done) li.classList.add("done");
        li.innerHTML = `
          <label>
            <input type="checkbox" ${done ? "checked" : ""}>
            ${title} (${from.slice(11, 16)} ‚Äì ${to.slice(11, 16)})
          </label>
          <button class="delete-btn" title="T√∂rl√©s">üóëÔ∏è</button>
        `;
        // √°llapotv√°lt√°s
        li.querySelector("input").onchange = () => {
          doc.ref.update({ done: !done }).then(fetchMonthlyEventsAndRender);
        };
        // t√∂rl√©s (PIN prompttal ‚Äì csak UI! L√°sd biztons√°gi megjegyz√©st)
        li.querySelector(".delete-btn").onclick = () =>
          askPinForDelete(() => { doc.ref.delete().then(fetchMonthlyEventsAndRender); });

        eventList.appendChild(li);
      });
    }, err => console.log(err));
}

/* --- Esem√©ny ≈±rlap --- */
eventForm.onsubmit = function (e) {
  e.preventDefault();
  const title = document.getElementById("event-title").value.trim();
  const fromTime = document.getElementById("event-from-time").value;
  const toTime = document.getElementById("event-to-time").value;

  if (!title || !fromTime || !toTime) return;

  // id≈ërend valid√°ci√≥
  if (toTime <= fromTime) {
    alert("A befejez√©s id≈ëpontj√°nak k√©s≈ëbbinek kell lennie, mint a kezd√©snek.");
    return;
  }

  db.collection("events").add({
    title,
    from: `${selectedDay}T${fromTime}`,
    to: `${selectedDay}T${toTime}`,
    done: false
  }).then(() => {
    fetchMonthlyEventsAndRender();
    // a napi lista a snapshot miatt mag√°t√≥l friss√ºl
    eventForm.reset();
  }).catch(err => console.log(err));
};

/* --- Lista (bev√°s√°rl√≥) --- */
function subscribeItems() {
  if (itemsUnsub) { itemsUnsub(); itemsUnsub = null; }
  itemsUnsub = db.collection("items").orderBy("title").onSnapshot(snap => {
    itemList.innerHTML = "";
    snap.forEach(doc => {
      const { title, done } = doc.data();
      const li = document.createElement("li");
      if (done) li.classList.add("done");
      li.innerHTML = `
        <label>
          <input type="checkbox" ${done ? "checked" : ""}>
          ${title}
        </label>
        <button class="delete-btn" title="T√∂rl√©s">üóëÔ∏è</button>
      `;
      li.querySelector("input").onchange = () => {
        doc.ref.update({ done: !done });
      };
      li.querySelector(".delete-btn").onclick = () =>
        askPinForDelete(() => doc.ref.delete());
      itemList.appendChild(li);
    });
  }, err => console.log(err));
}

itemForm.onsubmit = function (e) {
  e.preventDefault();
  const title = document.getElementById("item-title").value.trim();
  if (!title) return;
  db.collection("items").add({ title, done: false })
    .then(() => itemForm.reset())
    .catch(err => console.log(err));
};

/* --- T√∂rl√©s PIN --- */
function askPinForDelete(cb) {
  const pin = prompt("T√∂rl√©shez add meg a PIN-t:");
  if (pin === CORRECT_PIN) cb();
  else alert("Hib√°s PIN!");
}

/* --- Service Worker --- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js")
    .then(reg => console.log("SW regisztr√°lva!", reg.scope))
    .catch(err => console.log("SW hiba:", err));
}

/* --- N√©vnap --- */
function maiNevnap() {
  const today = new Date();
  const month = today.getMonth() + 1;
  const day = today.getDate();
  const key = month + '-' + day;
  const box = document.getElementById('nevnap-box');
  if (typeof nevnapok !== "undefined" && nevnapok[key]) {
    box.textContent = "Ma " + nevnapok[key].join(', ') + " napja van!";
  } else {
    box.textContent = "Ma nincs hivatalos n√©vnap.";
  }
}
maiNevnap();
</script>
</body>
</html>
